# 反共享机制测试清单

## 📋 当前配置

```javascript
MAX_DEVICES: 4                    // 最大2台设备
CITY_CHECK_START_INDEX: 2        // 第1台是基线，从第2台开始检测城市
RATE_LIMIT_ENABLED: true         // 启用访问次数限制
RATE_LIMITS: {
  1: 2,   // 1台设备：2次/天
  2: 4    // 2台设备：4次/天
}
```

---

## 🧪 测试场景清单

### 一、基础场景（单设备单城市）

#### 1.1 首次激活
- [✅] **场景**：新Token首次访问
- **操作**：Shadowrocket/Tokyo → 访问订阅
- **预期结果**：
  - ✅ 激活成功，返回正常节点
  - 📱 收到Telegram"订阅已激活"通知
  - 💾 KV数据：deviceCount=1, dailyCount=1

#### 1.2 正常访问（同设备同城市）
- [✅] **场景**：第2次访问（未超次数限制）
- **操作**：Shadowrocket/Tokyo → 再次访问
- **预期结果**：
  - ✅ 访问成功，返回正常节点
  - 📱 收到Telegram"订阅被访问"通知
  - 💾 KV数据：deviceCount=1, dailyCount=2

#### 1.3 访问次数超限
- [✅] **场景**：第3次访问（超出1台设备的2次限制）
- **操作**：Shadowrocket/Tokyo → 第3次访问
- **预期结果**：
  - ❌ 拒绝访问，返回错误节点
  - 📱 收到Telegram"⏰ 访问次数超限"通知
  - 错误提示：`今日访问次数超限 / 已访问: 2次 / 限制: 2次`
  - 💾 KV数据：dailyCount不再增加

---

### 二、多设备场景（城市检测关闭）

#### 2.1 第2台设备（同城市）
- [ ] **场景**：添加第2台设备，同城市
- **操作**：Loon/Tokyo → 访问订阅
- **预期结果**：
  - ✅ 访问成功（设备数未超限）
  - 📱 收到Telegram"订阅被访问"通知
  - 💾 KV数据：deviceCount=2, dailyCount=1（新设备计数重置）

#### 2.2 第2台设备多次访问
- [ ] **场景**：第2台设备访问3次
- **操作**：Loon/Tokyo → 访问3次
- **预期结果**：
  - ✅ 前2次成功（2台设备限制4次/天）
  - ❌ 第3次成功
  - ❌ 第4次成功
  - ❌ 第5次拒绝（超出2台设备的4次限制）
  - 💾 KV数据：dailyCount=4

#### 2.3 第3台设备（设备数超限）
- [ ] **场景**：尝试添加第3台设备
- **操作**：Surge/Tokyo → 访问订阅
- **预期结果**：
  - ❌ 拒绝访问，返回错误节点
  - 📱 收到Telegram"🚫 设备数超限"通知
  - 通知内容：`已有设备数: 2 / 限制数量: 2 / 尝试添加: 第3台设备`
  - 错误提示：`设备数超限 / 当前: 3台 / 限制: 2台`
  - 💾 KV数据：deviceCount保持为2（未添加第3台）

---

### 三、城市检测场景

#### 3.1 单设备换城市（不检测）
- [ ] **场景**：第1台设备从Tokyo换到Phoenix
- **操作**：Shadowrocket/Phoenix → 访问订阅
- **预期结果**：
  - ✅ 访问成功（CITY_CHECK_START_INDEX=1，第1台不检测城市）
  - 📱 收到Telegram"订阅被访问"通知
  - 💾 KV数据：cities包含tokyo和phoenix

#### 3.2 第2台设备+新城市（共享检测）
- [ ] **场景**：第2台设备从不同城市访问
- **操作**：
  1. Shadowrocket/Tokyo → 激活
  2. Loon/Phoenix → 访问
- **预期结果**：
  - ❌ 拒绝访问，触发"新设备+新城市"检测
  - 📱 收到Telegram"🚫 新设备新城市"通知
  - 通知内容：`账户已有城市: Tokyo / 当前城市: Phoenix / 已有设备数: 1 / 尝试添加: 第2台设备`
  - 错误提示：`新设备+新城市 / 检测到可疑的共享行为 / 如需添加新设备，请先使用已有城市`
  - 💾 KV数据：deviceCount保持为1

#### 3.3 第2台设备+已有城市（允许）
- [ ] **场景**：第2台设备使用已有城市
- **操作**：
  1. Shadowrocket/Tokyo → 激活
  2. Loon/Tokyo → 访问
- **预期结果**：
  - ✅ 访问成功（城市已存在，允许添加）
  - 📱 收到Telegram"订阅被访问"通知
  - 💾 KV数据：deviceCount=2

#### 3.4 已存在设备换城市（代理检测）
- [ ] **场景**：已添加的设备从新城市访问
- **操作**：
  1. Shadowrocket/Tokyo → 激活
  2. Loon/Tokyo → 添加第2台设备
  3. Loon/Phoenix → 第2台设备换城市访问
- **预期结果**：
  - ❌ 拒绝访问，触发"已存在设备+新城市"检测
  - 📱 收到Telegram"🌍 城市异常"通知
  - 通知内容：`该设备已使用城市: Tokyo / 当前城市: Phoenix`
  - 错误提示：`请使用常用节点或关闭代理后重试`
  - 💾 KV数据：不添加新城市记录

---

### 四、边界场景

#### 4.1 并发访问（同时首次激活）
- [ ] **场景**：两台设备几乎同时首次访问
- **操作**：快速连续访问
  1. Shadowrocket/Tokyo
  2. Loon/Phoenix（间隔<1秒）
- **预期结果**：
  - ✅ 第1个请求成功
  - ❌ 第2个请求可能触发"新设备+新城市"检测

#### 4.2 Unknown城市
- [ ] **场景**：无法获取城市信息的IP
- **操作**：通过无法解析城市的IP访问
- **预期结果**：
  - ⚠️ 城市记录为"Unknown"
  - ✅ 正常访问（不触发城市检测）

#### 4.3 每日计数重置
- [ ] **场景**：跨天访问，dailyCount重置
- **操作**：
  1. 今天访问2次（dailyCount=2）
  2. 明天00:00后访问
- **预期结果**：
  - ✅ 访问成功（计数已重置）
  - 💾 KV数据：dailyDate更新，dailyCount=1

#### 4.4 订阅过期后访问
- [ ] **场景**：订阅过期后尝试访问
- **操作**：等待订阅过期后访问
- **预期结果**：
  - ❌ 拒绝访问（在反共享检测之前被过期检测拦截）
  - 错误提示：`订阅已过期`

---

### 五、组合场景

#### 5.1 设备数接近上限时的城市检测
- [ ] **场景**：已有1台设备，添加第2台（不同城市）
- **操作**：
  1. Shadowrocket/Tokyo → 激活
  2. Loon/Phoenix → 访问
- **预期结果**：
  - ❌ 被"新设备+新城市"拦截（优先级高于设备数检测）

#### 5.2 访问次数接近上限时添加新设备
- [ ] **场景**：dailyCount=1，添加第2台设备
- **操作**：
  1. Shadowrocket/Tokyo → 访问1次
  2. Loon/Tokyo → 添加第2台设备
- **预期结果**：
  - ✅ 第2台设备添加成功
  - 💾 KV数据：dailyCount保持为1（第2台设备未计入）
  - 注意：后续该Token的限制会从2次/天提升到4次/天

#### 5.3 设备数超限后的访问次数统计
- [ ] **场景**：被设备数拦截后，dailyCount是否增加
- **操作**：
  1. 已有2台设备
  2. Surge/Tokyo → 尝试添加第3台
- **预期结果**：
  - ❌ 被设备数拦截
  - 💾 KV数据：dailyCount不增加（检测失败不计数）

---

## 📊 测试矩阵总结

| 场景分类 | 测试点数量 | 状态 |
|---------|-----------|------|
| 基础场景 | 3 | ⬜ |
| 多设备场景 | 3 | ⬜ |
| 城市检测 | 4 | ⬜ |
| 边界场景 | 4 | ⬜ |
| 组合场景 | 3 | ⬜ |
| **总计** | **17** | **0/17** |

---

## 🔍 测试注意事项

### 测试前准备
1. 确保Cloudflare Workers已部署最新代码
2. 确认Telegram Bot配置正确（能收到通知）
3. 准备多个代理IP（模拟不同城市）
4. 准备多个客户端User-Agent

### 测试工具
```bash
# 基础测试命令
curl -H "User-Agent: Shadowrocket/2832 CFNetwork/1402.0.8 Darwin/22.2.0 iPhone15,3" \
     https://your-domain.com/publicshare/test/your-token

# 模拟不同设备
curl -H "User-Agent: Loon/904 CFNetwork/1402.0.8 Darwin/22.2.0" \
     https://your-domain.com/publicshare/test/your-token

# 查看KV数据（通过Cloudflare Dashboard）
# Key: user:your-token
```

### 清理测试数据
每次测试前建议：
1. 重新生成新Token（避免旧数据干扰）
2. 或手动清理KV中的用户数据

---

## ✅ 测试结果记录

### 测试环境
- **测试日期**：____年__月__日
- **Workers域名**：____________________
- **测试Token**：____________________

### 问题记录
| 场景编号 | 问题描述 | 预期 | 实际 | 状态 |
|---------|---------|------|------|------|
|         |         |      |      |      |

---

## 📝 备注

- ✅ = 测试通过
- ❌ = 测试发现问题
- ⚠️ = 需要进一步验证
- ⬜ = 未测试
